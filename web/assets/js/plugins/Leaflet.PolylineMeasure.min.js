(function(factory){if(typeof define==='function'&&define.amd){define(['leaflet'],factory);}else if(typeof module!=='undefined'){module.exports=factory(require('leaflet'));}else{if(typeof window.L==='undefined'){throw new Error('Leaflet must be loaded first');}
factory(window.L);}}(function(L){var _measureControlId='polyline-measure-control';var _unicodeClass='polyline-measure-unicode-icon';var isMacOS=navigator.platform==='MacIntel';L.Control.PolylineMeasure=L.Control.extend({options:{position:'topleft',unit:'kilometres',useSubunits:true,clearMeasurementsOnStop:true,showBearings:false,bearingTextIn:'In',bearingTextOut:'Out',tooltipTextFinish:'Click to <b>finish line</b><br>',tooltipTextDelete:'Press SHIFT-key and click to <b>delete point</b>',tooltipTextMove:'Click and drag to <b>move point</b><br>',tooltipTextResume:'<br>Press '+(isMacOS?'⌘':'CTRL-key')+' and click to <b>resume line</b>',tooltipTextAdd:'Press '+(isMacOS?'⌘':'CTRL-key')+' and click to <b>add point</b>',measureControlTitleOn:"Turn on PolylineMeasure",measureControlTitleOff:"Turn off PolylineMeasure",measureControlLabel:'&#8614;',measureControlClasses:[],showClearControl:false,clearControlTitle:'Clear Measurements',clearControlLabel:'&times;',clearControlClasses:[],showUnitControl:false,unitControlUnits:["kilometres","landmiles","nauticalmiles"],unitControlTitle:{text:'Change Units',kilometres:'kilometres',landmiles:'land miles',nauticalmiles:'nautical miles'},unitControlLabel:{metres:'m',kilometres:'km',feet:'ft',landmiles:'mi',nauticalmiles:'nm'},unitControlClasses:[],tempLine:{color:'#00f',weight:2},fixedLine:{color:'#006',weight:2},arrow:{color:'#000'},startCircle:{color:'#000',weight:1,fillColor:'#0f0',fillOpacity:1,radius:3},intermedCircle:{color:'#000',weight:1,fillColor:'#ff0',fillOpacity:1,radius:3},currentCircle:{color:'#000',weight:1,fillColor:'#f0f',fillOpacity:1,radius:6},endCircle:{color:'#000',weight:1,fillColor:'#f00',fillOpacity:1,radius:3}},_arcpoints:99,_circleNr:-1,_lineNr:-1,_createControl:function(label,title,classesToAdd,container,fn,context){var anchor=document.createElement('a');anchor.innerHTML=label;anchor.setAttribute('title',title);classesToAdd.forEach(function(c){anchor.classList.add(c);});L.DomEvent.on(anchor,'click',fn,context);container.appendChild(anchor);return anchor;},onAdd:function(map){var self=this
map.on('movestart ',function(){self._mapdragging=true})
this._container=document.createElement('div');this._container.classList.add('leaflet-bar');L.DomEvent.disableClickPropagation(this._container);var title=this.options.measureControlTitleOn;var label=this.options.measureControlLabel;var classes=this.options.measureControlClasses;if(label.indexOf('&')!=-1){classes.push(_unicodeClass);}
this._arrPolylines=[];this._measureControl=this._createControl(label,title,classes,this._container,this._toggleMeasure,this);this._defaultControlBgColor=this._measureControl.style.backgroundColor;this._measureControl.setAttribute('id',_measureControlId);if(this.options.showClearControl){var title=this.options.clearControlTitle;var label=this.options.clearControlLabel;var classes=this.options.clearControlClasses;if(label.indexOf('&')!=-1){classes.push(_unicodeClass);}
this._clearMeasureControl=this._createControl(label,title,classes,this._container,this._clearAllMeasurements,this);this._clearMeasureControl.classList.add('polyline-measure-clearControl')}
if(this.options.showUnitControl&&this.options.unitControlUnits.length>1){var label=this.options.unitControlLabel[this.options.unit];var title=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle[this.options.unit]+"]";var classes=this.options.unitControlClasses;this._unitControl=this._createControl(label,title,classes,this._container,this._changeUnit,this);this._unitControl.setAttribute('id','unitControlId');}
return this._container;},onRemove:function(){if(this._measuring){this._toggleMeasure();}},_saveNonpolylineEvents:function(){this._nonpolylineTargets=this._map._targets;if(typeof this._polylineTargets!=='undefined'){this._map._targets=this._polylineTargets;}else{this._map._targets={};}},_savePolylineEvents:function(){this._polylineTargets=this._map._targets;this._map._targets=this._nonpolylineTargets;},_toggleMeasure:function(){this._measuring=!this._measuring;if(this._measuring){this._mapdragging=false;this._saveNonpolylineEvents();this._measureControl.classList.add('polyline-measure-controlOnBgColor');this._measureControl.style.backgroundColor=this.options.backgroundColor;this._measureControl.title=this.options.measureControlTitleOff;this._oldCursor=this._map._container.style.cursor;this._map._container.style.cursor='crosshair';this._doubleClickZoom=this._map.doubleClickZoom.enabled();this._map.doubleClickZoom.disable();if(!this._layerPaint){this._layerPaint=L.layerGroup().addTo(this._map);}
this._map.on('mousemove',this._mouseMove,this);this._map.on('click',this._mouseClick,this);L.DomEvent.on(document,'keydown',this._onKeyDown,this);this._resetPathVariables();}else{this._savePolylineEvents();this._measureControl.classList.remove('polyline-measure-controlOnBgColor');this._measureControl.style.backgroundColor=this._defaultControlBgColor;this._measureControl.title=this.options.measureControlTitleOn;this._map._container.style.cursor=this._oldCursor;this._map.off('mousemove',this._mouseMove,this);this._map.off('click',this._mouseClick,this);this._map.off('mousemove',this._resumeFirstpointMousemove,this);this._map.off('click',this._resumeFirstpointClick,this);this._map.off('mousemove',this._dragCircleMousemove,this);this._map.off('mouseup',this._dragCircleMouseup,this);L.DomEvent.off(document,'keydown',this._onKeyDown,this);if(this._doubleClickZoom){this._map.doubleClickZoom.enable();}
if(this.options.clearMeasurementsOnStop&&this._layerPaint){this._clearAllMeasurements();}
if(this._cntCircle!==0){this._finishPolylinePath();}}
this._map.fire('polylinemeasure:toggle',{status:this._measuring});},_clearAllMeasurements:function(){if((this._cntCircle!==undefined)&&(this._cntCircle!==0)){this._finishPolylinePath();}
if(this._layerPaint){this._layerPaint.clearLayers();}
this._arrPolylines=[];this._map.fire('polylinemeasure:clear');},_changeUnit:function(){let indexCurrUnit=this.options.unitControlUnits.indexOf(this.options.unit);let indexNextUnit=(indexCurrUnit+1)%this.options.unitControlUnits.length;this.options.unit=this.options.unitControlUnits[indexNextUnit];this._unitControl.innerHTML=this.options.unitControlLabel[this.options.unit];this._unitControl.title=this.options.unitControlTitle.text+" ["+this.options.unitControlTitle[this.options.unit]+"]";if(this._currentLine){this._computeDistance(this._currentLine);}
this._arrPolylines.map(this._computeDistance.bind(this));},_computeDistance:function(line){var totalDistance=0;line.circleCoords.map(function(point,point_index){if(point_index>=1){var distance=line.circleCoords[point_index-1].distanceTo(line.circleCoords[point_index]);totalDistance+=distance;this._updateTooltip(line.tooltips[point_index],line.tooltips[point_index-1],totalDistance,distance,line.circleCoords[point_index-1],line.circleCoords[point_index]);}}.bind(this));},_onKeyDown:function(e){if(e.keyCode===27){if(this._resumeFirstpointFlag===true){this._resumeFirstpointFlag=false;var lineNr=this._lineNr;this._map.off('mousemove',this._resumeFirstpointMousemove,this);this._map.off('click',this._resumeFirstpointClick,this);this._layerPaint.removeLayer(this._rubberlinePath2);this._layerPaint.removeLayer(this._tooltipNew);this._arrPolylines[lineNr].circleMarkers[0].setStyle(this.options.startCircle);var text='';var totalDistance=0;if(this.options.showBearings===true){text=this.options.bearingTextIn+':---°<br>'+this.options.bearingTextOut+':---°';}
text=text+'<div class="polyline-measure-tooltip-difference">+'+'0</div>';text=text+'<div class="polyline-measure-tooltip-total">'+'0</div>';this._arrPolylines[lineNr].tooltips[0]._icon.innerHTML=text;this._arrPolylines[lineNr].tooltips.map(function(item,index){if(index>=1){var distance=this._arrPolylines[lineNr].circleCoords[index-1].distanceTo(this._arrPolylines[lineNr].circleCoords[index]);var lastCircleCoords=this._arrPolylines[lineNr].circleCoords[index-1];var mouseCoords=this._arrPolylines[lineNr].circleCoords[index];totalDistance+=distance;var prevTooltip=this._arrPolylines[lineNr].tooltips[index-1]
this._updateTooltip(item,prevTooltip,totalDistance,distance,lastCircleCoords,mouseCoords);}}.bind(this));this._map.on('mousemove',this._mouseMove,this);return}
if(!this._currentLine){this._toggleMeasure();}else{this._finishPolylinePath(e);}}},_getDistance:function(distance){var dist=distance;var unit;if(this.options.unit==='nauticalmiles'){unit=this.options.unitControlLabel.nauticalmiles;if(dist>=185200){dist=(dist/1852).toFixed(0);}else if(dist>=18520){dist=(dist/1852).toFixed(1);}else if(dist>=1852){dist=(dist/1852).toFixed(2);}else{dist=(dist/1852).toFixed(3);}}else if(this.options.unit==='landmiles'){unit=this.options.unitControlLabel.landmiles;if(dist>=160934.4){dist=(dist/1609.344).toFixed(0);}else if(dist>=16093.44){dist=(dist/1609.344).toFixed(1);}else if(dist>=1609.344){dist=(dist/1609.344).toFixed(2);}else{if(!this.options.useSubunits){dist=(dist/1609.344).toFixed(4);}else{dist=(dist/0.3048).toFixed(0);unit=this.options.unitControlLabel.feet;}}}
else{unit=this.options.unitControlLabel.kilometres;if(dist>=100000){dist=(dist/1000).toFixed(0);}else if(dist>=10000){dist=(dist/1000).toFixed(1);}else if(dist>=1000){dist=(dist/1000).toFixed(2);}else{if(!this.options.useSubunits){dist=(dist/1000).toFixed(4);}else{dist=(dist).toFixed(1);unit=this.options.unitControlLabel.metres;}}}
return{value:dist,unit:unit};},_polylineArc:function(_from,_to){function _GCinterpolate(f){var A=Math.sin((1-f)*d)/Math.sin(d);var B=Math.sin(f*d)/Math.sin(d);var x=A*Math.cos(fromLat)*Math.cos(fromLng)+B*Math.cos(toLat)*Math.cos(toLng);var y=A*Math.cos(fromLat)*Math.sin(fromLng)+B*Math.cos(toLat)*Math.sin(toLng);var z=A*Math.sin(fromLat)+B*Math.sin(toLat);var latInterpol=180/Math.PI*Math.atan2(z,Math.sqrt(Math.pow(x,2)+Math.pow(y,2)));var lngInterpol=180/Math.PI*Math.atan2(y,x);var diff=lngInterpol-fromLng*180/Math.PI;function trunc(n){return Math[n>0?"floor":"ceil"](n);}
if(diff<0){lngInterpol=lngInterpol-trunc((diff-180)/360)*360;}else{lngInterpol=lngInterpol-trunc((diff+180)/360)*360;}
return[latInterpol,lngInterpol];}
function _GCarc(npoints){var arrArcCoords=[];var delta=1.0/(npoints-1);for(var i=0;i<npoints;i++){var step=delta*i;var coordPair=_GCinterpolate(step);arrArcCoords.push(coordPair);}
return arrArcCoords;}
var fromLat=_from.lat;var fromLng=_from.lng;var toLat=_to.lat;var toLng=_to.lng;fromLat=fromLat*Math.PI/180;fromLng=fromLng*Math.PI/180;toLat=toLat*Math.PI/180;toLng=toLng*Math.PI/180;var d=2.0*Math.asin(Math.sqrt(Math.pow(Math.sin((fromLat-toLat)/2.0),2)+Math.cos(fromLat)*Math.cos(toLat)*Math.pow(Math.sin((fromLng-toLng)/2.0),2)));var arrLatLngs;if(d===0){arrLatLngs=[[fromLat,fromLng]];}else{arrLatLngs=_GCarc(this._arcpoints);}
return arrLatLngs;},_updateTooltip:function(currentTooltip,prevTooltip,total,difference,lastCircleCoords,mouseCoords){var calcAngle=function(p1,p2,direction){var lat1=p1.lat/180*Math.PI;var lat2=p2.lat/180*Math.PI;var lng1=p1.lng/180*Math.PI;var lng2=p2.lng/180*Math.PI;var y=Math.sin(lng2-lng1)*Math.cos(lat2);var x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(lng2-lng1);if(direction==="inbound"){var brng=(Math.atan2(y,x)*180/Math.PI+180).toFixed(0);}else{var brng=(Math.atan2(y,x)*180/Math.PI+360).toFixed(0);}
return(brng%360);}
var angleIn=calcAngle(mouseCoords,lastCircleCoords,"inbound");var angleOut=calcAngle(lastCircleCoords,mouseCoords,"outbound");var totalRound=this._getDistance(total);var differenceRound=this._getDistance(difference);var textCurrent='';if(differenceRound.value>0){if(this.options.showBearings===true){textCurrent=this.options.bearingTextIn+': '+angleIn+'°<br>'+this.options.bearingTextOut+':---°';}
textCurrent+='<div class="polyline-measure-tooltip-difference">+'+differenceRound.value+'&nbsp;'+differenceRound.unit+'</div>';}
textCurrent+='<div class="polyline-measure-tooltip-total">'+totalRound.value+'&nbsp;'+totalRound.unit+'</div>';currentTooltip._icon.innerHTML=textCurrent;if((this.options.showBearings===true)&&(prevTooltip)){var textPrev=prevTooltip._icon.innerHTML;var regExp=new RegExp(this.options.bearingTextOut+'.*\°');var textReplace=textPrev.replace(regExp,this.options.bearingTextOut+': '+angleOut+"°");prevTooltip._icon.innerHTML=textReplace;}},_drawArrow:function(arcLine){var midpoint=Math.trunc(arcLine.length/2);if(arcLine.length%2==0){var P1=arcLine[midpoint-1];var P2=arcLine[midpoint];var diffLng12=P2[1]-P1[1];var diffLat12=P2[0]-P1[0];var center=[P1[0]+diffLat12/2,P1[1]+diffLng12/2];}else{var P1=arcLine[midpoint-1];var P2=arcLine[midpoint+1];var diffLng12=P2[1]-P1[1];var diffLat12=P2[0]-P1[0];var center=arcLine[midpoint];}
var cssAngle=-Math.atan2(diffLat12,diffLng12)*57.29578
var iconArrow=L.divIcon({className:"",iconSize:[16,16],iconAnchor:[8,8],html:"<div style = 'color:"+this.options.arrow.color+"; font-size: 16px; line-height: 16px; vertical-align:top; transform: rotate("+cssAngle+"deg)'>&#x27a4;</div>"});var newArrowMarker=L.marker(center,{icon:iconArrow,zIndexOffset:-50}).addTo(this._layerPaint);if(!this._currentLine){newArrowMarker.bindTooltip(this.options.tooltipTextAdd,{direction:'top',className:'polyline-measure-popupTooltip'});}
newArrowMarker.on('click',this._clickedArrow,this);return newArrowMarker;},_mouseMove:function(e){var mouseCoords=e.latlng;this._map.on('click',this._mouseClick,this);if(!mouseCoords||!this._currentLine){return;}
var lastCircleCoords=this._currentLine.circleCoords.last();this._rubberlinePath.setLatLngs(this._polylineArc(lastCircleCoords,mouseCoords));var currentTooltip=this._currentLine.tooltips.last();var prevTooltip=this._currentLine.tooltips.slice(-2,-1)[0];currentTooltip.setLatLng(mouseCoords);var distanceSegment=mouseCoords.distanceTo(lastCircleCoords);this._updateTooltip(currentTooltip,prevTooltip,this._currentLine.distance+distanceSegment,distanceSegment,lastCircleCoords,mouseCoords);},_startLine:function(clickCoords){var icon=L.divIcon({className:'polyline-measure-tooltip',iconAnchor:[-4,-4]});var last=function(){return this.slice(-1)[0];};this._rubberlinePath=L.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:false,dashArray:'8,8'}).addTo(this._layerPaint).bringToBack();var polylineState=this;this._currentLine={id:0,circleCoords:[],circleMarkers:[],arrowMarkers:[],tooltips:[],distance:0,polylinePath:L.polyline([],{color:this.options.fixedLine.color,weight:this.options.fixedLine.weight,interactive:false}).addTo(this._layerPaint).bringToBack(),handleMarkers:function(latlng){var lastCircleMarker=this.circleMarkers.last();if(lastCircleMarker){lastCircleMarker.bindTooltip(polylineState.options.tooltipTextDelete,{direction:'top',className:'polyline-measure-popupTooltip'});lastCircleMarker.off('click',polylineState._finishPolylinePath,polylineState);if(this.circleMarkers.length===1){lastCircleMarker.setStyle(polylineState.options.startCircle);}else{lastCircleMarker.setStyle(polylineState.options.intermedCircle);}}
var newCircleMarker=new L.CircleMarker(latlng,polylineState.options.currentCircle).addTo(polylineState._layerPaint);newCircleMarker.bindTooltip(polylineState.options.tooltipTextFinish+polylineState.options.tooltipTextDelete,{direction:'top',className:'polyline-measure-popupTooltip'});newCircleMarker.cntLine=polylineState._currentLine.id;newCircleMarker.cntCircle=polylineState._cntCircle;polylineState._cntCircle++;newCircleMarker.on('mousedown',polylineState._dragCircle,polylineState);newCircleMarker.on('click',polylineState._finishPolylinePath,polylineState);this.circleMarkers.push(newCircleMarker);},getNewToolTip:function(latlng){return L.marker(latlng,{icon:icon,interactive:false});},addPoint:function(mouseCoords){var lastCircleCoords=this.circleCoords.last();if(lastCircleCoords&&lastCircleCoords.equals(mouseCoords)){return;}
this.circleCoords.push(mouseCoords);if(this.circleCoords.length>1){var arc=polylineState._polylineArc(lastCircleCoords,mouseCoords);var arrowMarker=polylineState._drawArrow(arc);if(this.circleCoords.length>2){arc.shift();}
this.polylinePath.setLatLngs(this.polylinePath.getLatLngs().concat(arc));arrowMarker.cntLine=polylineState._currentLine.id;arrowMarker.cntArrow=polylineState._cntCircle-1;polylineState._currentLine.arrowMarkers.push(arrowMarker);var distanceSegment=lastCircleCoords.distanceTo(mouseCoords);this.distance+=distanceSegment;var currentTooltip=polylineState._currentLine.tooltips.last();var prevTooltip=polylineState._currentLine.tooltips.slice(-1,-2)[0];polylineState._updateTooltip(currentTooltip,prevTooltip,this.distance,distanceSegment,lastCircleCoords,mouseCoords);}
if(currentTooltip){currentTooltip.setLatLng(mouseCoords);}
var tooltipNew=this.getNewToolTip(mouseCoords);tooltipNew.addTo(polylineState._layerPaint);this.tooltips.push(tooltipNew);this.handleMarkers(mouseCoords);},finalize:function(){polylineState._layerPaint.removeLayer(this.tooltips.last());this.tooltips.pop();polylineState._layerPaint.removeLayer(polylineState._rubberlinePath);if(this.circleCoords.length>1){this.tooltips.last()._icon.classList.add('polyline-measure-tooltip-end');var lastCircleMarker=this.circleMarkers.last()
lastCircleMarker.setStyle(polylineState.options.endCircle);lastCircleMarker.unbindTooltip();polylineState._currentLine.circleMarkers.map(function(circle){circle.bindTooltip(polylineState.options.tooltipTextMove+polylineState.options.tooltipTextDelete,{direction:'top',className:'polyline-measure-popupTooltip'})});polylineState._currentLine.circleMarkers[0].bindTooltip(polylineState.options.tooltipTextMove+polylineState.options.tooltipTextDelete+polylineState.options.tooltipTextResume,{direction:'top',className:'polyline-measure-popupTooltip'});lastCircleMarker.bindTooltip(polylineState.options.tooltipTextMove+polylineState.options.tooltipTextDelete+polylineState.options.tooltipTextResume,{direction:'top',className:'polyline-measure-popupTooltip'});polylineState._currentLine.arrowMarkers.map(function(arrow){arrow.bindTooltip(polylineState.options.tooltipTextAdd,{direction:'top',className:'polyline-measure-popupTooltip'})});lastCircleMarker.off('click',polylineState._finishPolylinePath,polylineState);lastCircleMarker.on('click',polylineState._resumePolylinePath,polylineState);polylineState._arrPolylines[this.id]=this;}else{polylineState._layerPaint.removeLayer(this.circleMarkers.last());polylineState._layerPaint.removeLayer(this.tooltips.last());}
polylineState._resetPathVariables();}};var firstTooltip=L.marker(clickCoords,{icon:icon,interactive:false})
firstTooltip.addTo(this._layerPaint);var text='';if(this.options.showBearings===true){text=this.options.bearingTextIn+':---°<br>'+this.options.bearingTextOut+':---°';}
text=text+'<div class="polyline-measure-tooltip-difference">+'+'0</div>';text=text+'<div class="polyline-measure-tooltip-total">'+'0</div>';firstTooltip._icon.innerHTML=text;this._currentLine.tooltips.push(firstTooltip);this._currentLine.circleCoords.last=last;this._currentLine.tooltips.last=last;this._currentLine.circleMarkers.last=last;this._currentLine.id=this._arrPolylines.length;},_mouseClick:function(e){if(!e.latlng||(this._finishCircleScreencoords&&this._finishCircleScreencoords.equals(e.containerPoint))){return;}
if(!this._currentLine&&!this._mapdragging){this._startLine(e.latlng);this._map.fire('polylinemeasure:start',this._currentLine);}
if(!this._mapdragging){this._currentLine.addPoint(e.latlng);this._map.fire('polylinemeasure:add',e);this._map.fire('polylinemeasure:change',this._currentLine);}else{this._mapdragging=false;}},_finishPolylinePath:function(e){this._map.fire('polylinemeasure:finish',this._currentLine);this._currentLine.finalize();if(e){this._finishCircleScreencoords=e.containerPoint;}},_resumePolylinePath:function(e){if(e.originalEvent.ctrlKey===true||e.originalEvent.metaKey===true){this._currentLine=this._arrPolylines[e.target.cntLine];this._rubberlinePath=L.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:false,dashArray:'8,8'}).addTo(this._layerPaint).bringToBack();this._currentLine.tooltips.last()._icon.classList.remove('polyline-measure-tooltip-end');var tooltipNew=this._currentLine.getNewToolTip(e.latlng);tooltipNew.addTo(this._layerPaint);this._currentLine.tooltips.push(tooltipNew);this._currentLine.circleMarkers.last().unbindTooltip();this._currentLine.circleMarkers.last().bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:'top',className:'polyline-measure-popupTooltip'});this._currentLine.circleMarkers.last().setStyle(this.options.currentCircle);this._cntCircle=this._currentLine.circleCoords.length;this._map.fire('polylinemeasure:resume',this._currentLine);}},_resetPathVariables:function(){this._cntCircle=0;this._currentLine=null;},_clickedArrow:function(e){if(e.originalEvent.ctrlKey||e.originalEvent.metaKey){var lineNr=e.target.cntLine;var arrowNr=e.target.cntArrow;this._arrPolylines[lineNr].arrowMarkers[arrowNr].removeFrom(this._layerPaint);var newCircleMarker=new L.CircleMarker(e.latlng,this.options.intermedCircle).addTo(this._layerPaint);newCircleMarker.cntLine=lineNr;newCircleMarker.on('mousedown',this._dragCircle,this);newCircleMarker.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:'top',className:'polyline-measure-popupTooltip'});this._arrPolylines[lineNr].circleMarkers.splice(arrowNr+1,0,newCircleMarker);this._arrPolylines[lineNr].circleMarkers.map(function(item,index){item.cntCircle=index;});this._arrPolylines[lineNr].circleCoords.splice(arrowNr+1,0,e.latlng);var lineCoords=this._arrPolylines[lineNr].polylinePath.getLatLngs();var arc1=this._polylineArc(this._arrPolylines[lineNr].circleCoords[arrowNr],e.latlng);arc1.pop();var arc2=this._polylineArc(e.latlng,this._arrPolylines[lineNr].circleCoords[arrowNr+2]);Array.prototype.splice.apply(lineCoords,[(arrowNr)*(this._arcpoints-1),this._arcpoints].concat(arc1,arc2));this._arrPolylines[lineNr].polylinePath.setLatLngs(lineCoords);var arrowMarker=this._drawArrow(arc1);this._arrPolylines[lineNr].arrowMarkers[arrowNr]=arrowMarker;arrowMarker=this._drawArrow(arc2);this._arrPolylines[lineNr].arrowMarkers.splice(arrowNr+1,0,arrowMarker);this._arrPolylines[lineNr].arrowMarkers.map(function(item,index){item.cntLine=lineNr;item.cntArrow=index;});this._tooltipNew=L.marker(e.latlng,{icon:L.divIcon({className:'polyline-measure-tooltip',iconAnchor:[-4,-4]}),interactive:false});this._tooltipNew.addTo(this._layerPaint);this._arrPolylines[lineNr].tooltips.splice(arrowNr+1,0,this._tooltipNew);var totalDistance=0;this._arrPolylines[lineNr].tooltips.map(function(item,index){if(index>=1){var distance=this._arrPolylines[lineNr].circleCoords[index-1].distanceTo(this._arrPolylines[lineNr].circleCoords[index]);var lastCircleCoords=this._arrPolylines[lineNr].circleCoords[index-1];var mouseCoords=this._arrPolylines[lineNr].circleCoords[index];totalDistance+=distance;var prevTooltip=this._arrPolylines[lineNr].tooltips[index-1]
this._updateTooltip(item,prevTooltip,totalDistance,distance,lastCircleCoords,mouseCoords);}}.bind(this));this._map.fire('polylinemeasure:insert',e);this._map.fire('polylinemeasure:change',this._arrPolylines[this._lineNr]);}},_dragCircleMouseup:function(){if((this._circleNr===0)||(this._circleNr===this._arrPolylines[this._lineNr].circleCoords.length-1)){this._e1.target.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:'top',className:'polyline-measure-popupTooltip'});}else{this._e1.target.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:'top',className:'polyline-measure-popupTooltip'});}
this._resetPathVariables();this._map.off('mousemove',this._dragCircleMousemove,this);this._map.dragging.enable();this._map.on('mousemove',this._mouseMove,this);this._map.off('mouseup',this._dragCircleMouseup,this);this._map.fire('polylinemeasure:move',this._e1);this._map.fire('polylinemeasure:change',this._arrPolylines[this._lineNr]);},_dragCircleMousemove:function(e2){var mouseNewLat=e2.latlng.lat;var mouseNewLng=e2.latlng.lng;var latDifference=mouseNewLat-this._mouseStartingLat;var lngDifference=mouseNewLng-this._mouseStartingLng;var currentCircleCoords=L.latLng(this._circleStartingLat+latDifference,this._circleStartingLng+lngDifference);var arcpoints=this._arcpoints;var lineNr=this._e1.target.cntLine;this._lineNr=lineNr;var circleNr=this._e1.target.cntCircle;this._circleNr=circleNr;this._e1.target.setLatLng(currentCircleCoords);this._e1.target.unbindTooltip();this._arrPolylines[lineNr].circleCoords[circleNr]=currentCircleCoords;var lineCoords=this._arrPolylines[lineNr].polylinePath.getLatLngs();if(circleNr>=1){var newLineSegment1=this._polylineArc(this._arrPolylines[lineNr].circleCoords[circleNr-1],currentCircleCoords);Array.prototype.splice.apply(lineCoords,[(circleNr-1)*(arcpoints-1),arcpoints].concat(newLineSegment1));var arrowMarker=this._drawArrow(newLineSegment1);arrowMarker.cntLine=lineNr;arrowMarker.cntArrow=circleNr-1;this._arrPolylines[lineNr].arrowMarkers[circleNr-1].removeFrom(this._layerPaint);this._arrPolylines[lineNr].arrowMarkers[circleNr-1]=arrowMarker;}
if(circleNr<this._arrPolylines[lineNr].circleCoords.length-1){var newLineSegment2=this._polylineArc(currentCircleCoords,this._arrPolylines[lineNr].circleCoords[circleNr+1]);Array.prototype.splice.apply(lineCoords,[circleNr*(arcpoints-1),arcpoints].concat(newLineSegment2));arrowMarker=this._drawArrow(newLineSegment2);arrowMarker.cntLine=lineNr;arrowMarker.cntArrow=circleNr;this._arrPolylines[lineNr].arrowMarkers[circleNr].removeFrom(this._layerPaint);this._arrPolylines[lineNr].arrowMarkers[circleNr]=arrowMarker;}
this._arrPolylines[lineNr].polylinePath.setLatLngs(lineCoords);if(circleNr>=0){this._arrPolylines[lineNr].tooltips[circleNr].setLatLng(currentCircleCoords);}
var totalDistance=0;this._arrPolylines[lineNr].tooltips.map(function(item,index){if(index>=1){var distance=this._arrPolylines[lineNr].circleCoords[index-1].distanceTo(this._arrPolylines[lineNr].circleCoords[index]);var lastCircleCoords=this._arrPolylines[lineNr].circleCoords[index-1];var mouseCoords=this._arrPolylines[lineNr].circleCoords[index];totalDistance+=distance;this._arrPolylines[lineNr].distance=totalDistance;var prevTooltip=this._arrPolylines[lineNr].tooltips[index-1]
this._updateTooltip(item,prevTooltip,totalDistance,distance,lastCircleCoords,mouseCoords);}}.bind(this));this._map.on('mouseup',this._dragCircleMouseup,this);},_resumeFirstpointMousemove:function(e){var lineNr=this._lineNr;this._map.on('click',this._resumeFirstpointClick,this);var mouseCoords=e.latlng;this._rubberlinePath2.setLatLngs(this._polylineArc(mouseCoords,currentCircleCoords));this._tooltipNew.setLatLng(mouseCoords);var totalDistance=0;var distance=mouseCoords.distanceTo(this._arrPolylines[lineNr].circleCoords[0]);var lastCircleCoords=mouseCoords;var currentCoords=this._arrPolylines[lineNr].circleCoords[0];totalDistance+=distance;var prevTooltip=this._tooltipNew;var currentTooltip=this._arrPolylines[lineNr].tooltips[0]
this._updateTooltip(currentTooltip,prevTooltip,totalDistance,distance,lastCircleCoords,currentCoords);this._arrPolylines[lineNr].tooltips.map(function(item,index){if(index>=1){var distance=this._arrPolylines[lineNr].circleCoords[index-1].distanceTo(this._arrPolylines[lineNr].circleCoords[index]);var lastCircleCoords=this._arrPolylines[lineNr].circleCoords[index-1];var mouseCoords=this._arrPolylines[lineNr].circleCoords[index];totalDistance+=distance;var prevTooltip=this._arrPolylines[lineNr].tooltips[index-1]
this._updateTooltip(item,prevTooltip,totalDistance,distance,lastCircleCoords,mouseCoords);}}.bind(this));},_resumeFirstpointClick:function(e){var lineNr=this._lineNr;this._resumeFirstpointFlag=false;this._map.off('mousemove',this._resumeFirstpointMousemove,this);this._map.off('click',this._resumeFirstpointClick,this);this._layerPaint.removeLayer(this._rubberlinePath2);this._arrPolylines[lineNr].circleMarkers[0].setStyle(this.options.intermedCircle);this._arrPolylines[lineNr].circleMarkers[0].unbindTooltip();this._arrPolylines[lineNr].circleMarkers[0].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete,{direction:'top',className:'polyline-measure-popupTooltip'});var newCircleMarker=new L.CircleMarker(e.latlng,this.options.startCircle).addTo(this._layerPaint);newCircleMarker.cntLine=lineNr;newCircleMarker.cntCircle=0;newCircleMarker.on('mousedown',this._dragCircle,this);newCircleMarker.bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:'top',className:'polyline-measure-popupTooltip'});this._arrPolylines[lineNr].circleMarkers.unshift(newCircleMarker);this._arrPolylines[lineNr].circleMarkers.map(function(item,index){item.cntCircle=index;});this._arrPolylines[lineNr].circleCoords.unshift(e.latlng);var arc=this._polylineArc(e.latlng,currentCircleCoords);var arrowMarker=this._drawArrow(arc);this._arrPolylines[lineNr].arrowMarkers.unshift(arrowMarker);this._arrPolylines[lineNr].arrowMarkers.map(function(item,index){item.cntLine=lineNr;item.cntArrow=index;});arc.pop();this._arrPolylines[lineNr].polylinePath.setLatLngs(arc.concat(this._arrPolylines[lineNr].polylinePath.getLatLngs()));this._arrPolylines[lineNr].tooltips.unshift(this._tooltipNew);this._map.on('mousemove',this._mouseMove,this);},_dragCircle:function(e1){var arcpoints=this._arcpoints;if(e1.originalEvent.ctrlKey||e1.originalEvent.metaKey){this._map.off('click',this._mouseClick,this);if(e1.target.cntCircle===0){this._resumeFirstpointFlag=true;this._lineNr=e1.target.cntLine;var lineNr=this._lineNr;this._circleNr=e1.target.cntCircle;currentCircleCoords=e1.latlng;this._arrPolylines[lineNr].circleMarkers[0].setStyle(this.options.currentCircle);this._rubberlinePath2=L.polyline([],{color:this.options.tempLine.color,weight:this.options.tempLine.weight,interactive:false,dashArray:'8,8'}).addTo(this._layerPaint).bringToBack();this._tooltipNew=L.marker(currentCircleCoords,{icon:L.divIcon({className:'polyline-measure-tooltip',iconAnchor:[-4,-4]}),interactive:false});this._tooltipNew.addTo(this._layerPaint);var text='';if(this.options.showBearings===true){text=text+this.options.bearingTextIn+':---°<br>'+this.options.bearingTextOut+':---°';}
text=text+'<div class="polyline-measure-tooltip-difference">+'+'0</div>';text=text+'<div class="polyline-measure-tooltip-total">'+'0</div>';this._tooltipNew._icon.innerHTML=text;this._map.off('mousemove',this._mouseMove,this);this._map.on('mousemove',this._resumeFirstpointMousemove,this);}
return;}
if(e1.originalEvent.shiftKey){this._lineNr=e1.target.cntLine;var lineNr=this._lineNr;this._circleNr=e1.target.cntCircle;var circleNr=this._circleNr;if((this._layerPaint.hasLayer(this._rubberlinePath))&&(lineNr===this._currentLine.id)){this._cntCircle--;if(this._currentLine.circleMarkers.length===1){this._currentLine.finalize();return;}
this._currentLine.circleCoords.splice(circleNr,1);this._currentLine.circleMarkers[circleNr].removeFrom(this._layerPaint);this._currentLine.circleMarkers.splice(circleNr,1);this._currentLine.circleMarkers.map(function(item,index){item.cntCircle=index;});lineCoords=this._currentLine.polylinePath.getLatLngs();this._currentLine.tooltips[circleNr].removeFrom(this._layerPaint);this._currentLine.tooltips.splice(circleNr,1);if(circleNr===0){if(this._currentLine.circleMarkers.length===1){this._currentLine.circleMarkers[0].setStyle(this.options.currentCircle);}else{this._currentLine.circleMarkers[0].setStyle(this.options.startCircle);}
lineCoords.splice(0,arcpoints-1);this._currentLine.circleMarkers[0].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:'top',className:'polyline-measure-popupTooltip'});this._currentLine.arrowMarkers[circleNr].removeFrom(this._layerPaint);this._currentLine.arrowMarkers.splice(0,1);var text='';if(this.options.showBearings===true){text=this.options.bearingTextIn+':---°<br>'+this.options.bearingTextOut+':---°';}
text=text+'<div class="polyline-measure-tooltip-difference">+'+'0</div>';text=text+'<div class="polyline-measure-tooltip-total">'+'0</div>';this._currentLine.tooltips[0]._icon.innerHTML=text;}else if(circleNr===this._currentLine.circleCoords.length){this._currentLine.circleMarkers[circleNr-1].on('click',this._resumePolylinePath,this);this._currentLine.circleMarkers[circleNr-1].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:'top',className:'polyline-measure-popupTooltip'});this._currentLine.circleMarkers.slice(-1)[0].setStyle(this.options.currentCircle);lineCoords.splice(-(arcpoints-1),arcpoints-1);this._currentLine.arrowMarkers[circleNr-1].removeFrom(this._layerPaint);this._currentLine.arrowMarkers.splice(-1,1);}else{newLineSegment=this._polylineArc(this._currentLine.circleCoords[circleNr-1],this._currentLine.circleCoords[circleNr]);Array.prototype.splice.apply(lineCoords,[(circleNr-1)*(arcpoints-1),(2*arcpoints-1)].concat(newLineSegment));this._currentLine.arrowMarkers[circleNr-1].removeFrom(this._layerPaint);this._currentLine.arrowMarkers[circleNr].removeFrom(this._layerPaint);arrowMarker=this._drawArrow(newLineSegment);this._currentLine.arrowMarkers.splice(circleNr-1,2,arrowMarker);}
this._currentLine.polylinePath.setLatLngs(lineCoords);this._currentLine.arrowMarkers.map(function(item,index){item.cntLine=lineNr;item.cntArrow=index;});var totalDistanceUnfinishedLine=0;this._currentLine.tooltips.map(function(item,index,arr){if(index>=1){var distance,mouseCoords;var prevTooltip=this._currentLine.tooltips[index-1];var lastCircleCoords=this._currentLine.circleCoords[index-1];if(index===arr.length-1){distance=this._currentLine.circleCoords[index-1].distanceTo(e1.latlng);mouseCoords=e1.latlng;this._updateTooltip(item,prevTooltip,totalDistanceUnfinishedLine+distance,distance,lastCircleCoords,mouseCoords);}else{distance=this._currentLine.circleCoords[index-1].distanceTo(this._currentLine.circleCoords[index]);mouseCoords=this._currentLine.circleCoords[index];totalDistanceUnfinishedLine+=distance;this._updateTooltip(item,prevTooltip,totalDistanceUnfinishedLine,distance,lastCircleCoords,mouseCoords);}}}.bind(this));this._currentLine.distance=totalDistanceUnfinishedLine;}else{if(this._arrPolylines[lineNr].circleMarkers.length===2){this._layerPaint.removeLayer(this._arrPolylines[lineNr].circleMarkers[1]);this._layerPaint.removeLayer(this._arrPolylines[lineNr].tooltips[1]);this._layerPaint.removeLayer(this._arrPolylines[lineNr].circleMarkers[0]);this._layerPaint.removeLayer(this._arrPolylines[lineNr].tooltips[0]);this._layerPaint.removeLayer(this._arrPolylines[lineNr].arrowMarkers[0]);this._layerPaint.removeLayer(this._arrPolylines[lineNr].polylinePath);this._map.fire('polylinemeasure:remove',e1);this._map.fire('polylinemeasure:change',this._arrPolylines[this._lineNr]);return;}
this._arrPolylines[lineNr].circleCoords.splice(circleNr,1);this._arrPolylines[lineNr].circleMarkers[circleNr].removeFrom(this._layerPaint);this._arrPolylines[lineNr].circleMarkers.splice(circleNr,1);this._arrPolylines[lineNr].circleMarkers.map(function(item,index){item.cntCircle=index;});var lineCoords=this._arrPolylines[lineNr].polylinePath.getLatLngs();this._arrPolylines[lineNr].tooltips[circleNr].removeFrom(this._layerPaint);this._arrPolylines[lineNr].tooltips.splice(circleNr,1);if(!this._arrPolylines[lineNr].circleMarkers.length){this._arrPolylines.splice(lineNr,1);this._arrPolylines.forEach(function(line,index){line.circleMarkers.map(function(item){item.cntLine=index;});line.arrowMarkers.map(function(item){item.cntLine=index;});});return;}
if(circleNr===0){this._arrPolylines[lineNr].circleMarkers[0].setStyle(this.options.startCircle);lineCoords.splice(0,arcpoints-1);this._arrPolylines[lineNr].circleMarkers[0].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:'top',className:'polyline-measure-popupTooltip'});this._arrPolylines[lineNr].arrowMarkers[circleNr].removeFrom(this._layerPaint);this._arrPolylines[lineNr].arrowMarkers.splice(0,1);var text='';if(this.options.showBearings===true){text=this.options.bearingTextIn+':---°<br>'+this.options.bearingTextOut+':---°';}
text=text+'<div class="polyline-measure-tooltip-difference">+'+'0</div>';text=text+'<div class="polyline-measure-tooltip-total">'+'0</div>';this._arrPolylines[lineNr].tooltips[0]._icon.innerHTML=text;}else if(circleNr===this._arrPolylines[lineNr].circleCoords.length){this._arrPolylines[lineNr].circleMarkers[circleNr-1].on('click',this._resumePolylinePath,this);this._arrPolylines[lineNr].circleMarkers[circleNr-1].bindTooltip(this.options.tooltipTextMove+this.options.tooltipTextDelete+this.options.tooltipTextResume,{direction:'top',className:'polyline-measure-popupTooltip'});this._arrPolylines[lineNr].circleMarkers.slice(-1)[0].setStyle(this.options.endCircle);this._arrPolylines[lineNr].tooltips.slice(-1)[0]._icon.classList.add('polyline-measure-tooltip-end');lineCoords.splice(-(arcpoints-1),arcpoints-1);this._arrPolylines[lineNr].arrowMarkers[circleNr-1].removeFrom(this._layerPaint);this._arrPolylines[lineNr].arrowMarkers.splice(-1,1);}else{var newLineSegment=this._polylineArc(this._arrPolylines[lineNr].circleCoords[circleNr-1],this._arrPolylines[lineNr].circleCoords[circleNr]);Array.prototype.splice.apply(lineCoords,[(circleNr-1)*(arcpoints-1),(2*arcpoints-1)].concat(newLineSegment));this._arrPolylines[lineNr].arrowMarkers[circleNr-1].removeFrom(this._layerPaint);this._arrPolylines[lineNr].arrowMarkers[circleNr].removeFrom(this._layerPaint);var arrowMarker=this._drawArrow(newLineSegment);this._arrPolylines[lineNr].arrowMarkers.splice(circleNr-1,2,arrowMarker);}
this._arrPolylines[lineNr].polylinePath.setLatLngs(lineCoords);this._arrPolylines[lineNr].arrowMarkers.map(function(item,index){item.cntLine=lineNr;item.cntArrow=index;});var totalDistance=0;this._arrPolylines[lineNr].tooltips.map(function(item,index){if(index>=1){var distance=this._arrPolylines[lineNr].circleCoords[index-1].distanceTo(this._arrPolylines[lineNr].circleCoords[index]);var lastCircleCoords=this._arrPolylines[lineNr].circleCoords[index-1];var mouseCoords=this._arrPolylines[lineNr].circleCoords[index];totalDistance+=distance;this._arrPolylines[lineNr].distance=totalDistance;var prevTooltip=this._arrPolylines[lineNr].tooltips[index-1];this._updateTooltip(item,prevTooltip,totalDistance,distance,lastCircleCoords,mouseCoords);}}.bind(this));}
this._map.fire('polylinemeasure:remove',e1);this._map.fire('polylinemeasure:change',this._arrPolylines[this._lineNr]);return;}
this._e1=e1;if((this._measuring)&&(this._cntCircle===0)){this._map.dragging.disable();this._map.off('mousemove',this._mouseMove,this);this._map.off('click',this._mouseClick,this);this._mouseStartingLat=e1.latlng.lat;this._mouseStartingLng=e1.latlng.lng;this._circleStartingLat=e1.target._latlng.lat;this._circleStartingLng=e1.target._latlng.lng;this._map.on('mousemove',this._dragCircleMousemove,this);}},seed:function(polylinesArray){polylinesArray.forEach((polyline)=>{this._toggleMeasure();this._startLine(polyline[0]);polyline.forEach((point,ind)=>{const latLng=L.latLng(point);this._mouseMove({latLng});this._currentLine.addPoint(latLng);if(ind===polyline.length-1){this._finishPolylinePath();this._toggleMeasure();}});});}});L.Map.mergeOptions({PolylineMeasureControl:false});L.Map.addInitHook(function(){if(this.options.polylineMeasureControl){this.PMControl=new L.Control.PolylineMeasure();this.addControl(this.PMControl);}});L.control.polylineMeasure=function(options){return new L.Control.PolylineMeasure(options);};return L.Control.PolylineMeasure;}));